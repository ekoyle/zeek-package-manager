# @TEST-EXEC: bash %INPUT

# @TEST-EXEC: zkg purge
# @TEST-EXEC: umask 0027 && zkg bundle test.bundle --manifest manifest.txt

# FIXME: this may be specific to gnu tar output format
# @TEST-EXEC: tar tvf test.bundle | grep -v git | awk '{ print $1, $2, $NF }' > bundle.out
# @TEST-EXEC: btest-diff bundle.out
# @TEST-EXEC: umask 0027 && zkg --config=my_zkg.config unbundle --force --replace test.bundle

# FIXME: this output may differ based on ls implementation
# @TEST-EXEC: ls -l state/script_dir/packages/rot13 state/clones/package/rot13 | grep -v 'git\|dist' | awk '{ print $1, $NF }' > unbundle.out
# @TEST-EXEC: btest-diff unbundle.out

# make sure the on-disk permissions will differ
chmod -R g-w,o-rwx packages/rot13

echo "$(pwd)/packages/rot13" >> sources/one/bob/zkg.index
cd sources/one
git commit -am 'add rot13 package'
cd ../..

echo "[bundle]" > manifest.txt
default_branch_name=$( cd packages/baz && git rev-parse --abbrev-ref HEAD )
echo "baz = ${default_branch_name}" >> manifest.txt
default_branch_name=$( cd packages/rot13 && git rev-parse --abbrev-ref HEAD )
echo "rot13 = ${default_branch_name}" >> manifest.txt

cat << EOF > my_zkg.config
[paths]
state_dir = $(pwd)/state

EOF
